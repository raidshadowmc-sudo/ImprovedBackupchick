{% extends "base.html" %}

{% block title %}Панель администратора{% endblock %}

{% block content %}
<div class="admin-panel">
    <!-- Enhanced Admin Header -->
    <div class="admin-header text-center py-4 mb-5 enhanced-admin-header">
        <div class="header-backdrop"></div>
        <div class="header-content">
            <h1 class="display-4 fw-bold admin-title mb-3">
                <i class="fas fa-crown admin-crown-icon me-3"></i>Панель администратора
            </h1>
            <p class="lead header-subtitle">Управление таблицей лидеров и игроками</p>
            {% if stats %}
            <div class="admin-stats-quick">
                <div class="quick-stat-item">
                    <div class="stat-number">{{ "{:,}".format(stats.total_players) }}</div>
                    <div class="stat-label">Игроков</div>
                </div>
                <div class="quick-stat-item">
                    <div class="stat-number">{{ "{:,}".format(stats.total_kills) }}</div>
                    <div class="stat-label">Убийств</div>
                </div>
                <div class="quick-stat-item">
                    <div class="stat-number">{{ "{:,}".format(stats.total_games) }}</div>
                    <div class="stat-label">Игр</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Enhanced Statistics Overview -->
    {% if stats %}
    <div class="enhanced-stats-overview mb-5">
        <div class="stats-header text-center mb-4">
            <h3 class="section-title gradient-text">
                <i class="fas fa-chart-bar text-info me-2 glow-effect"></i>Общая статистика сервера
            </h3>
            <p class="text-muted">Живая статистика Bedwars сервера в реальном времени</p>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="modern-stat-card players-card">
                    <div class="stat-header">
                        <div class="stat-icon-wrapper">
                            <i class="fas fa-users stat-icon"></i>
                        </div>
                        <div class="stat-trend positive">
                            <i class="fas fa-arrow-up"></i> +12%
                        </div>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ "{:,}".format(stats.total_players) }}</div>
                        <div class="stat-label">Всего игроков</div>
                        <div class="stat-subtitle">Зарегистрированных</div>
                    </div>
                    <div class="stat-progress">
                        <div class="progress-bar" style="width: 75%"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="modern-stat-card kills-card">
                    <div class="stat-header">
                        <div class="stat-icon-wrapper">
                            <i class="fas fa-sword stat-icon"></i>
                        </div>
                        <div class="stat-trend positive">
                            <i class="fas fa-arrow-up"></i> +8%
                        </div>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ "{:,}".format(stats.total_kills) }}</div>
                        <div class="stat-label">Всего убийств</div>
                        <div class="stat-subtitle">За все время</div>
                    </div>
                    <div class="stat-progress">
                        <div class="progress-bar" style="width: 85%"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="modern-stat-card games-card">
                    <div class="stat-header">
                        <div class="stat-icon-wrapper">
                            <i class="fas fa-gamepad stat-icon"></i>
                        </div>
                        <div class="stat-trend positive">
                            <i class="fas fa-arrow-up"></i> +15%
                        </div>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ "{:,}".format(stats.total_games) }}</div>
                        <div class="stat-label">Всего игр</div>
                        <div class="stat-subtitle">Сыграно</div>
                    </div>
                    <div class="stat-progress">
                        <div class="progress-bar" style="width: 65%"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="modern-stat-card beds-card">
                    <div class="stat-header">
                        <div class="stat-icon-wrapper">
                            <i class="fas fa-bed stat-icon"></i>
                        </div>
                        <div class="stat-trend positive">
                            <i class="fas fa-arrow-up"></i> +5%
                        </div>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ "{:,}".format(stats.total_beds_broken) }}</div>
                        <div class="stat-label">Кроватей сломано</div>
                        <div class="stat-subtitle">Всего разрушено</div>
                    </div>
                    <div class="stat-progress">
                        <div class="progress-bar" style="width: 90%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Statistics Row -->
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="secondary-stat-card">
                    <div class="stat-icon-small">
                        <i class="fas fa-trophy text-warning"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value">{{ "{:,}".format(stats.total_wins) }}</div>
                        <div class="stat-name">Побед</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="secondary-stat-card">
                    <div class="stat-icon-small">
                        <i class="fas fa-coins text-warning"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value">{{ "{:,}".format(stats.total_coins) }}</div>
                        <div class="stat-name">Койнов в обороте</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="secondary-stat-card">
                    <div class="stat-icon-small">
                        <i class="fas fa-star text-info"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value">{{ "{:,}".format(stats.total_reputation) }}</div>
                        <div class="stat-name">Репутации</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Enhanced Add Player Form -->
    <div class="enhanced-add-player-section mb-5">
        <div class="section-header text-center mb-4">
            <h3 class="section-title gradient-text">
                <i class="fas fa-user-plus text-success me-2 glow-effect"></i>Добавить нового игрока
            </h3>
            <p class="section-subtitle text-muted">Заполните информацию о новом игроке. Обязательные поля отмечены звездочкой (*)</p>
        </div>

        <form method="POST" action="{{ url_for('add_player') }}" class="multi-step-form" id="addPlayerForm">
            <div class="form-progress mb-4">
                <div class="progress-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Основные данные</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Игровая статистика</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Ресурсы и экономика</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Настройки профиля</div>
                </div>
            </div>
            <!-- Step 1: Basic Information -->
            <div class="form-step active" data-step="1">
                <div class="step-header">
                    <h5 class="mb-3">
                        <i class="fas fa-user-plus me-2 text-primary"></i>Основная информация
                    </h5>
                    <p class="text-muted">Введите базовые данные игрока</p>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="nickname" class="form-label required">
                            <i class="fas fa-user me-1"></i>Игровой ник
                        </label>
                        <input type="text" class="form-control" id="nickname" name="nickname" required
                               placeholder="Введите никнейм игрока" maxlength="16">
                        <div class="form-text">Уникальный игровой никнейм (до 16 символов)</div>
                    </div>
                    <div class="col-md-6">
                        <label for="role" class="form-label">
                            <i class="fas fa-crown me-1"></i>Роль
                        </label>
                        <select class="form-select" name="role" id="roleSelect">
                            <option value="Игрок">Игрок</option>
                            <option value="VIP">VIP</option>
                            <option value="VIP+">VIP+</option>
                            <option value="Модератор">Модератор</option>
                            <option value="Администратор">Администратор</option>
                            <option value="Владелец">Владелец</option>
                            <option value="custom">🎨 Кастомная роль...</option>
                        </select>
                    </div>

                    <!-- Custom Role Section -->
                    <div class="col-12" id="customRoleSection" style="display: none;">
                        <div class="custom-role-creator">
                            <div class="creator-header">
                                <h5 class="text-primary">
                                    <i class="fas fa-magic me-2"></i>Настройка кастомной роли
                                </h5>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-5">
                                    <label for="customRoleName" class="form-label required">Название роли</label>
                                    <input type="text" class="form-control" id="customRoleName" name="custom_role"
                                           placeholder="Например: Легенда" maxlength="50">
                                </div>
                                <div class="col-md-2">
                                    <label for="customRoleEmoji" class="form-label">Эмодзи</label>
                                    <div class="emoji-input-container">
                                        <input type="text" class="form-control emoji-input" id="customRoleEmoji" name="custom_role_emoji"
                                               placeholder="👑" maxlength="2">
                                        <button type="button" class="emoji-picker-btn" onclick="showEmojiPicker()">
                                            <i class="fas fa-smile"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="customRoleColor" class="form-label">Цвет</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control form-control-color" id="customRoleColor" name="custom_role_color" value="#ffc107">
                                        <input type="text" class="form-control color-text" id="customRoleColorText" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label for="useGradient" class="form-label">Градиент</label>
                                    <div class="gradient-toggle">
                                        <input type="checkbox" class="form-check-input me-1" id="useGradient" name="use_gradient">
                                        <label for="useGradient" class="form-label">Да</label>
                                    </div>
                                </div>

                                <div class="col-12 gradient-creator" id="gradientOptions" style="display: none;">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label for="gradientDirection" class="form-label">Направление</label>
                                            <select class="form-select" id="gradientDirection" name="gradient_direction">
                                                <option value="to right">Вправо</option>
                                                <option value="to left">Влево</option>
                                                <option value="to bottom">Вниз</option>
                                                <option value="to top">Вверх</option>
                                                <option value="45deg" selected>45deg</option>
                                                <option value="135deg">135deg</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="gradientEndColor" class="form-label">Конечный цвет</label>
                                            <div class="color-input-group">
                                                <input type="color" class="form-control form-control-color" id="gradientEndColor" name="gradient_end_color" value="#ff6b35">
                                                <input type="text" class="form-control color-text" id="gradientEndColorText" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="gradientAnimated" class="form-label">Анимация</label>
                                            <div class="gradient-toggle">
                                                <input type="checkbox" class="form-check-input me-1" id="gradientAnimated" name="gradient_animated">
                                                <label for="gradientAnimated" class="form-label">Да</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Предпросмотр</label>
                                    <div class="role-preview" id="rolePreview">
                                        <span class="role-display custom-role">🎭 Кастомная роль</span>
                                    </div>
                                </div>
                            </div>
                            <div class="emoji-suggestions">
                                <!-- Predefined emoji suggestions -->
                                <span onclick="selectEmoji('👑')">👑</span>
                                <span onclick="selectEmoji('⭐')">⭐</span>
                                <span onclick="selectEmoji('🌟')">🌟</span>
                                <span onclick="selectEmoji('💎')">💎</span>
                                <span onclick="selectEmoji('🔥')">🔥</span>
                                <span onclick="selectEmoji('⚡')">⚡</span>
                                <span onclick="selectEmoji('🚀')">🚀</span>
                                <span onclick="selectEmoji('🎯')">🎯</span>
                                <span onclick="selectEmoji('🏆')">🏆</span>
                                <span onclick="selectEmoji('💫')">💫</span>
                                <span onclick="selectEmoji('🎪')">🎪</span>
                                <span onclick="selectEmoji('🎭')">🎭</span>
                                <span onclick="selectEmoji('🎨')">🎨</span>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label for="server_ip" class="form-label">
                            <i class="fas fa-server me-1"></i>IP сервера
                        </label>
                        <input type="text" class="form-control" name="server_ip"
                               placeholder="play.example.com">
                        <div class="form-text">IP сервера где играет игрок (опционально)</div>
                    </div>
                    <div class="col-md-6">
                        <label for="experience" class="form-label">
                            <i class="fas fa-star me-1"></i>Опыт
                        </label>
                        <input type="number" class="form-control" name="experience" min="0" value="0">
                        <div class="form-text">Оставьте 0 для автоматического расчета по статистике</div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Game Statistics -->
            <div class="form-step" data-step="2">
                <div class="step-header">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-bar me-2 text-success"></i>Игровая статистика
                    </h5>
                    <p class="text-muted">Введите игровые показатели в Bedwars</p>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card bg-dark border-danger">
                            <div class="card-header">
                                <h6 class="text-danger mb-0">
                                    <i class="fas fa-sword me-2"></i>Боевые показатели
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label for="kills" class="form-label">Убийства</label>
                                        <input type="number" class="form-control stat-input" name="kills"
                                               min="0" max="999999" value="0" data-stat="kills">
                                    </div>
                                    <div class="col-6">
                                        <label for="final_kills" class="form-label">Финальные убийства</label>
                                        <input type="number" class="form-control stat-input" name="final_kills"
                                               min="0" max="999999" value="0" data-stat="final_kills">
                                    </div>
                                    <div class="col-6">
                                        <label for="deaths" class="form-label">Смерти</label>
                                        <input type="number" class="form-control stat-input" name="deaths"
                                               min="0" max="999999" value="0" data-stat="deaths">
                                    </div>
                                    <div class="col-6">
                                        <label for="final_deaths" class="form-label">Финальные смерти</label>
                                        <input type="number" class="form-control stat-input" name="final_deaths"
                                               min="0" max="999999" value="0" data-stat="final_deaths">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card bg-dark border-primary">
                            <div class="card-header">
                                <h6 class="text-primary mb-0">
                                    <i class="fas fa-trophy me-2"></i>Игровые показатели
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <label for="beds_broken" class="form-label">Кровати сломано</label>
                                        <input type="number" class="form-control stat-input" name="beds_broken"
                                               min="0" max="999999" value="0" data-stat="beds_broken">
                                    </div>
                                    <div class="col-6">
                                        <label for="games_played" class="form-label">Игры сыграно</label>
                                        <input type="number" class="form-control stat-input" name="games_played"
                                               min="0" max="999999" value="0" data-stat="games_played">
                                    </div>
                                    <div class="col-6">
                                        <label for="wins" class="form-label">Победы</label>
                                        <input type="number" class="form-control stat-input" name="wins"
                                               min="0" max="999999" value="0" data-stat="wins">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Auto-calculated stats display -->
                <div class="mt-4">
                    <div class="card bg-dark border-info">
                        <div class="card-header">
                            <h6 class="text-info mb-0">
                                <i class="fas fa-calculator me-2"></i>Автоматически рассчитанные показатели
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="stat-display">
                                        <div class="stat-value text-warning" id="calc-kd">0.00</div>
                                        <div class="stat-label">K/D Ratio</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-display">
                                        <div class="stat-value text-danger" id="calc-fkd">0.00</div>
                                        <div class="stat-label">FK/D Ratio</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-display">
                                        <div class="stat-value text-success" id="calc-winrate">0.0%</div>
                                        <div class="stat-label">Win Rate</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-display">
                                        <div class="stat-value text-primary" id="calc-level">1</div>
                                        <div class="stat-label">Уровень</div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 text-center">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Показатели обновляются автоматически при изменении статистики
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Step 3: Resources and Economy -->
            <div class="form-step" data-step="3">
                <div class="step-header">
                    <h5 class="mb-3">
                        <i class="fas fa-coins me-2 text-warning"></i>Ресурсы и экономика
                    </h5>
                    <p class="text-muted">Введите количество ресурсов и покупок игрока</p>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card bg-dark border-success">
                            <div class="card-header">
                                <h6 class="text-success mb-0">
                                    <i class="fas fa-gem me-2"></i>Собранные ресурсы
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label for="iron_collected" class="form-label">Железо</label>
                                        <input type="number" class="form-control resource-input" name="iron_collected"
                                               min="0" max="9999999" value="0" data-resource="iron_collected">
                                    </div>
                                    <div class="col-6">
                                        <label for="gold_collected" class="form-label">Золото</label>
                                        <input type="number" class="form-control resource-input" name="gold_collected"
                                               min="0" max="9999999" value="0" data-resource="gold_collected">
                                    </div>
                                    <div class="col-6">
                                        <label for="diamond_collected" class="form-label">Алмазы</label>
                                        <input type="number" class="form-control resource-input" name="diamond_collected"
                                               min="0" max="9999999" value="0" data-resource="diamond_collected">
                                    </div>
                                    <div class="col-6">
                                        <label for="emerald_collected" class="form-label">Изумруды</label>
                                        <input type="number" class="form-control resource-input" name="emerald_collected"
                                               min="0" max="9999999" value="0" data-resource="emerald_collected">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card bg-dark border-secondary">
                            <div class="card-header">
                                <h6 class="text-secondary mb-0">
                                    <i class="fas fa-shopping-cart me-2"></i>Экономика
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <label for="items_purchased" class="form-label">Покупок предметов</label>
                                        <input type="number" class="form-control economy-input" name="items_purchased"
                                               min="0" max="9999" value="0" data-economy="items_purchased">
                                    </div>
                                    <div class="col-12">
                                        <label for="coins_spent" class="form-label">Потрачено койнов</label>
                                        <input type="number" class="form-control economy-input" name="coins_spent"
                                               min="0" max="99999999" value="0" data-economy="coins_spent">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Profile Settings -->
            <div class="form-step" data-step="4">
                <div class="step-header">
                    <h5 class="mb-3">
                        <i class="fas fa-cog me-2 text-info"></i>Настройки профиля
                    </h5>
                    <p class="text-muted">Настройте внешний вид и опции профиля игрока</p>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card bg-dark border-primary">
                            <div class="card-header">
                                <h6 class="text-primary mb-0">
                                    <i class="fas fa-user-tag me-2"></i>Визуальное оформление
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <label class="form-label">
                                            <input type="checkbox" name="is_premium" class="form-check-input me-1"> Лицензионный аккаунт
                                        </label>
                                        <div class="form-text">Влияет на возможность загрузки скина по нику.</div>
                                    </div>
                                    <div class="col-6">
                                        <label for="skin_type" class="form-label">Тип скина</label>
                                        <select class="form-select" name="skin_type">
                                            <option value="auto">Автоматически (по нику)</option>
                                            <option value="steve">Стив (Classic)</option>
                                            <option value="alex">Алекс (Slim)</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label for="profile_background" class="form-label">Фон профиля</label>
                                        <input type="color" class="form-control form-control-color" name="profile_background" value="#1a1a1a">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card bg-dark border-secondary">
                            <div class="card-header">
                                <h6 class="text-secondary mb-0">
                                    <i class="fas fa-star-half-alt me-2"></i>Прогресс и цели
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <label for="next_level_xp" class="form-label">Опыт до следующего уровня</label>
                                        <input type="number" class="form-control xp-input" name="next_level_xp"
                                               min="0" value="0" data-xp="next_level_xp">
                                        <div class="form-text">Текущий уровень рассчитывается автоматически</div>
                                    </div>
                                    <div class="col-6">
                                        <label for="prestige" class="form-label">Престиж</label>
                                        <input type="number" class="form-control prestige-input" name="prestige"
                                               min="0" value="0" data-prestige="prestige">
                                    </div>
                                    <div class="col-6">
                                        <label for="prestige_level" class="form-label">Уровень престижа</label>
                                        <input type="number" class="form-control prestige-input" name="prestige_level"
                                               min="0" value="0" data-prestige="prestige_level">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-secondary btn-lg prev-step" disabled>
                    <i class="fas fa-arrow-left me-2"></i>Назад
                </button>
                <button type="button" class="btn btn-primary btn-lg next-step">
                    Далее<i class="fas fa-arrow-right ms-2"></i>
                </button>
                <button type="submit" class="btn btn-success btn-lg" style="display: none;">
                    <i class="fas fa-user-plus me-2"></i>Добавить игрока
                </button>
            </div>
        </form>
    </div>


    <!-- Recent Players -->
    <div class="recent-players-section mb-5">
        <h3 class="section-title mb-4">
            <i class="fas fa-clock text-warning me-2"></i>Недавно добавленные игроки
        </h3>
        <div class="table-responsive">
            <table class="table table-dark table-striped">
                <thead class="table-warning">
                    <tr>
                        <th>Игрок</th>
                        <th>Уровень</th>
                        <th>Опыт</th>
                        <th>K/D</th>
                        <th>Дата добавления</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in recent_players %}
                    <tr>
                        <td>
                            <div class="player-info">
                                <div class="fw-bold">{{ player.nickname }}</div>
                                <div class="text-muted small">{{ player.role }}</div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-warning text-dark fs-6">{{ player.level }}</span>
                        </td>
                        <td class="text-warning">{{ "{:,}".format(player.experience) }}</td>
                        <td>
                            <span class="stat-value {{ 'text-success' if player.kd_ratio >= 1.0 else 'text-danger' }}">
                                {{ player.kd_ratio }}
                            </span>
                        </td>
                        <td class="text-muted small">{{ player.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('player_profile', player_id=player.id) }}"
                                   class="btn btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="btn btn-outline-danger"
                                        onclick="confirmDelete({{ player.id }}, '{{ player.nickname }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>


    <!-- Enhanced Admin Actions -->
    <div class="enhanced-admin-actions mb-5">
        <div class="section-header text-center mb-4">
            <h3 class="section-title gradient-text">
                <i class="fas fa-tools text-danger me-2 glow-effect"></i>Инструменты администратора
            </h3>
            <p class="section-subtitle text-muted">Мощные инструменты для управления сервером</p>
        </div>

        <!-- Action Categories -->
        <div class="admin-categories mb-4">
            <div class="category-tab active" data-category="management">
                <i class="fas fa-users"></i>
                <span>Управление</span>
            </div>
            <div class="category-tab" data-category="content">
                <i class="fas fa-gamepad"></i>
                <span>Контент</span>
            </div>
            <div class="category-tab" data-category="customization">
                <i class="fas fa-palette"></i>
                <span>Кастомизация</span>
            </div>
            <div class="category-tab" data-category="system">
                <i class="fas fa-cogs"></i>
                <span>Система</span>
            </div>
        </div>

        <div class="actions-grid" id="adminActionsGrid">
            <!-- Management Category -->
            <div class="action-category active" data-category="management">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="action-card">
                            <div class="action-icon">
                                <i class="fas fa-download text-success"></i>
                            </div>
                            <div class="action-content">
                                <h5>Экспорт данных</h5>
                                <p class="text-muted small">Скачать данные в различных форматах</p>
                                <div class="d-flex flex-column gap-2">
                                    <a href="{{ url_for('export_leaderboard') }}" class="btn btn-sm btn-info">
                                        <i class="fas fa-download me-1"></i>Экспорт CSV
                                    </a>
                                    <a href="{{ url_for('export_database') }}" class="btn btn-sm btn-warning">
                                        <i class="fas fa-database me-1"></i>Экспорт БД (JSON)
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="action-card">
                            <div class="action-icon">
                                <i class="fas fa-upload text-success mb-2"></i>
                            </div>
                            <div class="action-content">
                                <h5>Импорт данных</h5>
                                <p class="text-muted small">Восстановить базу данных из резервной копии</p>
                                <a href="{{ url_for('import_database') }}" class="btn btn-sm btn-success">
                                    <i class="fas fa-upload me-1"></i>Импорт БД
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="action-card">
                            <div class="action-icon">
                                <i class="fas fa-gamepad text-warning"></i>
                            </div>
                            <div class="action-content">
                                <h5>Демо-данные</h5>
                                <p class="text-muted">Инициализировать тестовые данные</p>
                                <form method="POST" action="{{ url_for('init_demo') }}" style="display: inline;">
                                    <button type="submit" class="btn btn-warning" onclick="return confirm('Создать демо-игроков и квесты?')">
                                        <i class="fas fa-magic me-1"></i>Создать
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Content Category -->
            <div class="action-category" data-category="content">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="action-card">
                            <div class="action-icon">
                                <i class="fas fa-tasks text-info"></i>
                            </div>
                            <div class="action-content">
                                <h5>Квесты</h5>
                                <p class="text-muted">Управление системой квестов</p>
                                <a href="{{ url_for('admin_quests') }}" class="btn btn-info">
                                    <i class="fas fa-tasks me-1"></i>Управлять
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="action-card">
                            <div class="action-icon">
                                <i class="fas fa-trophy text-purple"></i>
                            </div>
                            <div class="action-content">
                                <h5>Достижения</h5>
                                <p class="text-muted">Управление системой достижений</p>
                                <a href="{{ url_for('admin_achievements') }}" class="btn" style="background-color: #6f42c1; color: white;">
                                    <i class="fas fa-trophy me-1"></i>Управлять
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="action-card">
                            <div class="action-icon text-primary">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <div class="action-content">
                                <h5>Квесты игроков</h5>
                                <p class="text-muted">Просмотр прогресса квестов</p>
                                <a href="{{ url_for('admin_player_quests') }}" class="btn btn-primary">
                                    <i class="fas fa-tasks me-2"></i>Просмотреть
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="action-card">
                            <div class="action-icon text-success">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <div class="action-content">
                                <h5>Достижения игроков</h5>
                                <p class="text-muted">Просмотр полученных достижений</p>
                                <a href="{{ url_for('admin_player_achievements') }}" class="btn btn-success">
                                    <i class="fas fa-trophy me-2"></i>Просмотреть
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Customization Category -->
            <div class="action-category" data-category="customization">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="action-card">
                            <div class="action-icon text-warning glow-effect">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="action-content">
                                <h5>Титулы и роли</h5>
                                <p class="text-muted">Создание и присвоение титулов</p>
                                <div class="d-flex flex-column gap-2">
                                    <a href="{{ url_for('admin_titles') }}" class="btn btn-outline-primary">
                                        <i class="fas fa-trophy me-2"></i>Управление титулами
                                    </a>
                                    <a href="{{ url_for('admin_roles') }}" class="btn btn-outline-success">
                                        <i class="fas fa-user-tag me-2"></i>{{ 'role_management'|t }}
                                    </a>
                                    <a href="{{ url_for('admin_badges') }}" class="btn btn-outline-warning">
                                        <i class="fas fa-medal me-2"></i>Управление бейджами
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="action-card">
                            <div class="action-icon">
                                <i class="fas fa-palette"></i>
                            </div>
                            <div class="action-content">
                                <h5>Оформление</h5>
                                <p class="text-muted">Управление внешним видом</p>
                                <div class="d-flex flex-column gap-2">
                                    <a href="{{ url_for('admin_themes') }}" class="btn btn-outline-primary">
                                        <i class="fas fa-palette me-2"></i>Темы
                                    </a>
                                    <a href="{{ url_for('admin_gradients') }}" class="btn btn-outline-warning">
                                        <i class="fas fa-magic me-2"></i>Градиенты
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="action-card">
                            <div class="action-icon">
                                <i class="fas fa-coins text-warning"></i>
                            </div>
                            <div class="action-content">
                                <h5>Экономика</h5>
                                <p class="text-muted">Управление игровой экономикой</p>
                                <div class="d-flex flex-column gap-2">
                                    <a href="{{ url_for('admin_reputation') }}" class="btn btn-outline-info">
                                        <i class="fas fa-star me-2"></i>Репутация
                                    </a>
                                    <a href="{{ url_for('admin_shop') }}" class="btn btn-outline-success">
                                        <i class="fas fa-store me-2"></i>Магазин
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- System Category -->
            <div class="action-category" data-category="system">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="action-card">
                            <div class="action-icon">
                                <i class="fas fa-chart-line text-success"></i>
                            </div>
                            <div class="action-content">
                                <h5>Статистика</h5>
                                <p class="text-muted">Подробная аналитика</p>
                                <a href="{{ url_for('statistics') }}" class="btn btn-success">
                                    <i class="fas fa-chart-bar me-1"></i>Посмотреть
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="action-card">
                            <div class="action-icon">
                                <i class="fas fa-trash text-danger"></i>
                            </div>
                            <div class="action-content">
                                <h5>Очистить таблицу</h5>
                                <p class="text-muted">Удалить всех игроков</p>
                                <button class="btn btn-danger" onclick="confirmClear()">
                                    <i class="fas fa-trash me-1"></i>Очистить
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить игрока <strong id="deletePlayerName"></strong>?</p>
                <p class="text-muted small">Это действие нельзя отменить.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Удалить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Clear Confirmation Modal -->
<div class="modal fade" id="clearModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title text-danger">Внимание!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Вы собираетесь удалить <strong>всех игроков</strong> из таблицы лидеров!</p>
                <p class="text-danger">Это действие нельзя отменить!</p>
                <p>Для подтверждения введите <strong>ОЧИСТИТЬ</strong>:</p>
                <input type="text" class="form-control" id="clearConfirmation" placeholder="Введите ОЧИСТИТЬ">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <form method="POST" action="{{ url_for('clear_leaderboard') }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger" id="clearSubmit" disabled>
                        Очистить таблицу
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Custom Role Creation Modal -->
<div class="modal fade" id="customRoleModal" tabindex="-1" aria-labelledby="customRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-primary" id="customRoleModalLabel">
                    <i class="fas fa-magic me-2"></i>Создать кастомную роль
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="modal_role_name" class="form-label">
                                <i class="fas fa-tag me-2"></i>Название роли
                            </label>
                            <input type="text" class="form-control bg-secondary text-light border-0"
                                   id="modal_role_name" placeholder="Введите название роли" required>
                        </div>

                        <div class="mb-3">
                            <label for="modal_role_emoji" class="form-label">
                                <i class="fas fa-smile me-2"></i>Эмодзи
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control bg-secondary text-light border-0"
                                       id="modal_role_emoji" placeholder="🎭" maxlength="2">
                                <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                                    Выбрать
                                </button>
                                <ul class="dropdown-menu bg-dark">
                                    <li><a class="dropdown-item text-light emoji-option" href="#" data-emoji="👑">👑 Корона</a></li>
                                    <li><a class="dropdown-item text-light emoji-option" href="#" data-emoji="⭐">⭐ Звезда</a></li>
                                    <li><a class="dropdown-item text-light emoji-option" href="#" data-emoji="🔥">🔥 Огонь</a></li>
                                    <li><a class="dropdown-item text-light emoji-option" href="#" data-emoji="💎">💎 Алмаз</a></li>
                                    <li><a class="dropdown-item text-light emoji-option" href="#" data-emoji="⚡">⚡ Молния</a></li>
                                    <li><a class="dropdown-item text-light emoji-option" href="#" data-emoji="🎭">🎭 Маски</a></li>
                                    <li><a class="dropdown-item text-light emoji-option" href="#" data-emoji="🏆">🏆 Трофей</a></li>
                                    <li><a class="dropdown-item text-light emoji-option" href="#" data-emoji="🌟">🌟 Звёздочка</a></li>
                                </ul>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="modal_role_color" class="form-label">
                                <i class="fas fa-palette me-2"></i>Цвет
                            </label>
                            <div class="input-group">
                                <input type="color" class="form-control form-control-color bg-secondary border-0"
                                       id="modal_role_color" value="#ffc107">
                                <div class="input-group-text bg-secondary border-0 text-light" id="color_preview">
                                    #ffc107
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="modal_has_gradient">
                                <label class="form-check-label text-light" for="modal_has_gradient">
                                    <i class="fas fa-gradient me-2"></i>Использовать градиент
                                </label>
                            </div>
                        </div>

                        <div class="mb-3" id="gradient_end_color_group" style="display: none;">
                            <label for="modal_gradient_end_color" class="form-label">
                                <i class="fas fa-fill-drip me-2"></i>Конечный цвет градиента
                            </label>
                            <div class="input-group">
                                <input type="color" class="form-control form-control-color bg-secondary border-0"
                                       id="modal_gradient_end_color" value="#ff6b35">
                                <div class="input-group-text bg-secondary border-0 text-light" id="gradient_color_preview">
                                    #ff6b35
                                </div>
                            </div>
                        </div>

                        <div class="mb-3" id="gradient_animated_group" style="display: none;">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="modal_gradient_animated">
                                <label class="form-check-label text-light" for="modal_gradient_animated">
                                    <i class="fas fa-sync-alt me-2"></i>Анимированный градиент
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="preview-section">
                            <h6 class="text-primary">
                                <i class="fas fa-eye me-2"></i>Предпросмотр
                            </h6>
                            <div class="preview-card bg-secondary p-4 rounded">
                                <div class="mb-3">
                                    <small class="text-muted">В лидерборде:</small>
                                    <div class="leaderboard-preview mt-2">
                                        <span id="role_preview_display">🎭 Кастомная роль</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">В профиле:</small>
                                    <div class="profile-preview mt-2">
                                        <div class="player-info d-flex align-items-center">
                                            <img src="https://mc-heads.net/avatar/steve/32" class="rounded me-2" alt="Avatar">
                                            <div>
                                                <div class="fw-bold">Игрок123</div>
                                                <div id="profile_role_preview">🎭 Кастомная роль</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Отмена
                </button>
                <button type="button" class="btn btn-primary" id="applyCustomRole">
                    <i class="fas fa-check me-2"></i>Применить роль
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Multi-step form logic
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('addPlayerForm');
    const steps = Array.from(form.querySelectorAll('.form-step'));
    const progressSteps = Array.from(form.querySelectorAll('.progress-step'));
    const nextButton = form.querySelector('.next-step');
    const prevButton = form.querySelector('.prev-step');
    const submitButton = form.querySelector('button[type="submit"]');

    let currentStep = 0;

    function updateFormUI() {
        steps.forEach((step, index) => {
            step.classList.toggle('active', index === currentStep);
        });
        progressSteps.forEach((step, index) => {
            step.classList.toggle('active', index === currentStep);
        });

        prevButton.disabled = currentStep === 0;
        nextButton.style.display = currentStep < steps.length - 1 ? 'inline-block' : 'none';
        submitButton.style.display = currentStep === steps.length - 1 ? 'inline-block' : 'none';
        // Corrected button text for the last step
        if (currentStep === steps.length - 1) {
            nextButton.querySelector('i').className = 'fas fa-arrow-right ms-2'; // Keep arrow for consistency
            nextButton.querySelector('span').textContent = 'Завершить'; // Change text to 'Finish' or similar
            nextButton.style.display = 'none'; // Hide next button as submit is visible
        } else {
            nextButton.querySelector('span').textContent = 'Далее'; // Reset text if not last step
            nextButton.querySelector('i').className = 'fas fa-arrow-right ms-2';
        }

    }

    function goToStep(stepIndex) {
        // Basic validation for the current step before moving
        const currentFormStep = steps[currentStep];
        let stepIsValid = true;

        if (currentStep === 0) { // Basic Information
            const nicknameInput = currentFormStep.querySelector('#nickname');
            if (!nicknameInput.value.trim()) {
                alert('Пожалуйста, введите игровой никнейм.');
                stepIsValid = false;
            }
        } else if (currentStep === 1) { // Game Statistics
            const statInputs = currentFormStep.querySelectorAll('.stat-input');
            for (const input of statInputs) {
                const value = parseInt(input.value);
                const min = parseInt(input.min);
                const max = parseInt(input.max);
                if (value < min || value > max) {
                    alert(`Значение для "${input.labels[0].textContent}" должно быть между ${min} и ${max}.`);
                    stepIsValid = false;
                    break;
                }
            }
            if (stepIsValid) {
                const wins = parseInt(currentFormStep.querySelector('#wins').value) || 0;
                const gamesPlayed = parseInt(currentFormStep.querySelector('#games_played').value) || 0;
                if (wins > gamesPlayed) {
                    alert('Количество побед не может превышать количество сыгранных игр.');
                    stepIsValid = false;
                }
            }
        } else if (currentStep === 2) { // Resources and Economy
            const resourceInputs = currentFormStep.querySelectorAll('.resource-input');
            for (const input of resourceInputs) {
                const value = parseInt(input.value);
                const min = parseInt(input.min);
                const max = parseInt(input.max);
                if (value < min || value > max) {
                    alert(`Значение для "${input.labels[0].textContent}" должно быть между ${min} и ${max}.`);
                    stepIsValid = false;
                    break;
                }
            }
            if (stepIsValid) {
                const economyInputs = currentFormStep.querySelectorAll('.economy-input');
                for (const input of economyInputs) {
                    const value = parseInt(input.value);
                    const min = parseInt(input.min);
                    const max = parseInt(input.max);
                    if (value < min || value > max) {
                        alert(`Значение для "${input.labels[0].textContent}" должно быть между ${min} и ${max}.`);
                        stepIsValid = false;
                        break;
                    }
                }
            }
        } else if (currentStep === 3) { // Profile Settings
             const xpInputs = currentFormStep.querySelectorAll('.xp-input');
            for (const input of xpInputs) {
                const value = parseInt(input.value);
                const min = parseInt(input.min);
                 if (value < min) {
                    alert(`Значение для "${input.labels[0].textContent}" не может быть отрицательным.`);
                    stepIsValid = false;
                    break;
                }
            }
            if (stepIsValid) {
                const prestigeInputs = currentFormStep.querySelectorAll('.prestige-input');
                 for (const input of prestigeInputs) {
                    const value = parseInt(input.value);
                    const min = parseInt(input.min);
                     if (value < min) {
                        alert(`Значение для "${input.labels[0].textContent}" не может быть отрицательным.`);
                        stepIsValid = false;
                        break;
                    }
                }
            }
        }


        if (stepIsValid) {
            currentStep = stepIndex;
            updateFormUI();
        }
    }

    nextButton.addEventListener('click', function() {
        goToStep(currentStep + 1);
    });

    prevButton.addEventListener('click', function() {
        goToStep(currentStep - 1);
    });

    // Update calculated stats
    const statInputs = form.querySelectorAll('.stat-input');
    const kdDisplay = form.querySelector('#calc-kd');
    const fkdDisplay = form.querySelector('#calc-fkd');
    const winrateDisplay = form.querySelector('#calc-winrate');
    const levelDisplay = form.querySelector('#calc-level');

    statInputs.forEach(input => {
        input.addEventListener('input', calculateStats);
    });
     // Also listen for changes on experience input
    form.querySelector('[name="experience"]').addEventListener('input', calculateStats);


    function calculateStats() {
        const kills = parseInt(form.querySelector('[name="kills"]').value) || 0;
        const finalKills = parseInt(form.querySelector('[name="final_kills"]').value) || 0;
        const deaths = parseInt(form.querySelector('[name="deaths"]').value) || 0;
        const finalDeaths = parseInt(form.querySelector('[name="final_deaths"]').value) || 0;
        const wins = parseInt(form.querySelector('[name="wins"]').value) || 0;
        const gamesPlayed = parseInt(form.querySelector('[name="games_played"]').value) || 0;

        const kdRatio = deaths === 0 ? (kills > 0 ? Infinity : 0) : (kills / deaths).toFixed(2);
        const fkdRatio = finalDeaths === 0 ? (finalKills > 0 ? Infinity : 0) : (finalKills / finalDeaths).toFixed(2);
        const winRate = gamesPlayed === 0 ? 0 : ((wins / gamesPlayed) * 100).toFixed(1);

        // Basic level calculation (example, can be more complex)
        let level = 1;
        let xpForNextLevel = 1000;
        let currentXp = parseInt(form.querySelector('[name="experience"]').value) || 0;

        if (currentXp > 0) {
            level = Math.floor(currentXp / 1000) + 1; // Simple XP system
            xpForNextLevel = level * 1000;
        } else {
            // If experience is 0, calculate based on stats if needed
            // For now, let's use a simpler calculation based on wins/games
             level = Math.floor(wins / 5) + 1; // Another simple level calc
        }


        kdDisplay.textContent = kdRatio === Infinity ? '∞' : kdRatio;
        fkdDisplay.textContent = fkdRatio === Infinity ? '∞' : fkdRatio;
        winrateDisplay.textContent = winRate + '%';
        levelDisplay.textContent = level;
    }

    // Initial calculation and UI update
    calculateStats();
    updateFormUI();

    // Custom Role System
    const roleSelect = document.getElementById('roleSelect');
    const customRoleSection = document.getElementById('customRoleSection');
    const customRoleModal = new bootstrap.Modal(document.getElementById('customRoleModal'));

    roleSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
            customRoleSection.style.display = 'block';
            // Scroll to the custom role section if it's not visible
            customRoleSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            updateRolePreview(); // Ensure preview is updated when selecting custom
        } else {
            customRoleSection.style.display = 'none';
        }
    });

    // Handle custom role application from modal
    document.getElementById('applyCustomRole').addEventListener('click', function() {
        const modalRoleName = document.getElementById('modal_role_name').value.trim();
        const modalRoleEmoji = document.getElementById('modal_role_emoji').value.trim() || '🎭';
        const modalRoleColor = document.getElementById('modal_role_color').value;
        const modalHasGradient = document.getElementById('modal_has_gradient').checked;
        const modalGradientEndColor = document.getElementById('modal_gradient_end_color').value;
        const modalGradientAnimated = document.getElementById('modal_gradient_animated').checked;
        const modalGradientDirection = document.getElementById('gradientDirection').value; // Get direction

        // Update the hidden inputs in the main form
        document.querySelector('input[name="custom_role"]').value = modalRoleName;
        document.querySelector('input[name="custom_role_emoji"]').value = modalRoleEmoji;
        document.querySelector('input[name="custom_role_color"]').value = modalRoleColor;
        document.querySelector('input[name="custom_role_animated"]').value = modalGradientAnimated;

        let gradientValue = '';
        if (modalHasGradient) {
            gradientValue = `linear-gradient(${modalGradientDirection}, ${modalRoleColor}, ${modalGradientEndColor})`;
            document.querySelector('input[name="custom_role_gradient"]').value = gradientValue;
        } else {
            document.querySelector('input[name="custom_role_gradient"]').value = '';
        }

        // Update the role select and preview in the main form
        roleSelect.value = 'custom';
        customRoleSection.style.display = 'block';
        updateRolePreview(); // Update the preview in the main form

        customRoleModal.hide();
    });

    // Role preview updates function (now internal to the script)
    function updateRolePreview() {
        const previewSpan = document.getElementById('rolePreview'); // Preview in the form
        const name = document.getElementById('customRoleName').value || 'Новая роль';
        const color = document.getElementById('customRoleColor').value;
        const emoji = document.getElementById('customRoleEmoji').value || '🎭';
        const useGradient = document.getElementById('useGradient').checked;

        let style = '';
        let displayText = `${emoji} ${name}`;

        if (useGradient) {
            const endColor = document.getElementById('gradientEndColor').value;
            const direction = document.getElementById('gradientDirection').value;
            const animated = document.getElementById('gradientAnimated').checked;

            const gradient = `linear-gradient(${direction}, ${color}, ${endColor})`;
            style = `
                background: ${gradient};
                background-size: 200% 200%;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                ${animated ? 'animation: gradientShift 3s ease-in-out infinite;' : ''}
            `;
        } else {
            style = `color: ${color};`;
        }
        previewSpan.innerHTML = `<span class="role-display custom-role" style="${style}">${displayText}</span>`;
    }

    // Event listeners for modal inputs to update preview
    document.getElementById('modal_role_name').addEventListener('input', updateRolePreview);
    document.getElementById('modal_role_emoji').addEventListener('input', updateRolePreview);
    document.getElementById('modal_role_color').addEventListener('input', updateRolePreview);
    document.getElementById('gradientEndColor').addEventListener('input', updateRolePreview);
    document.getElementById('gradientDirection').addEventListener('change', updateRolePreview);
    document.getElementById('gradientAnimated').addEventListener('change', updateRolePreview);

    // Toggle gradient options visibility
    document.getElementById('useGradient').addEventListener('change', function() {
        const gradientOptions = document.getElementById('gradientOptions');
        if (this.checked) {
            gradientOptions.style.display = 'block';
        } else {
            gradientOptions.style.display = 'none';
        }
        updateRolePreview(); // Update preview when gradient is toggled
    });

    // Emoji selection and feedback
    document.querySelectorAll('.emoji-suggestions span').forEach(span => {
        span.addEventListener('click', function() {
            document.getElementById('modal_role_emoji').value = this.textContent;
            updateRolePreview();
            // Visual feedback for selected emoji
            document.querySelectorAll('.emoji-suggestions span').forEach(s => s.classList.remove('selected'));
            this.classList.add('selected');
        });
    });

    // Initialize preview if custom role is pre-selected
    if (roleSelect.value === 'custom') {
        customRoleSection.style.display = 'block';
        // Check if custom role inputs are already filled (e.g., from server-side rendering)
        if (document.querySelector('input[name="custom_role"]').value) {
            document.getElementById('modal_role_name').value = document.querySelector('input[name="custom_role"]').value;
            document.getElementById('modal_role_emoji').value = document.querySelector('input[name="custom_role_emoji"]').value || '🎭';
            document.getElementById('modal_role_color').value = document.querySelector('input[name="custom_role_color"]').value || '#ffc107';
            const gradientInputVal = document.querySelector('input[name="custom_role_gradient"]').value;
            document.getElementById('useGradient').checked = !!gradientInputVal;
            if (gradientInputVal) {
                const match = gradientInputVal.match(/linear-gradient\((\w+,\s*#?[0-9a-fA-F]+,\s*#?[0-9a-fA-F]+)\)/);
                if (match && match[1]) {
                    const parts = match[1].split(',');
                    document.getElementById('gradientDirection').value = parts[0].trim();
                    document.getElementById('gradientEndColor').value = parts[2].trim();
                }
                // Assuming animated status is not directly stored in gradient input, default to off or add logic if it is
                document.getElementById('gradientAnimated').checked = false; // Default to false
            }
            updateRolePreview();
            toggleGradientOptions(); // Ensure gradient options visibility is correct
        } else {
            updateRolePreview(); // Update with defaults if no custom role data exists
        }
    }

    // Event listener for the custom role picker button
    document.querySelector('.emoji-picker-btn').addEventListener('click', function() {
        // A simple way to select an emoji, could be more sophisticated
        const emojis = ['👑', '⭐', '🌟', '💎', '🔥', '⚡', '🚀', '🎯', '🏆', '💫', '🎪', '🎭', '🎨'];
        const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
        document.getElementById('modal_role_emoji').value = randomEmoji;
        updateRolePreview();
    });

    // Sync color picker and text input
    document.getElementById('customRoleColor').addEventListener('input', function() {
        document.getElementById('customRoleColorText').value = this.value;
        updateRolePreview();
    });
    document.getElementById('gradientEndColor').addEventListener('input', function() {
        document.getElementById('gradientEndColorText').value = this.value;
        updateRolePreview();
    });
    // Initialize color text inputs on load
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('customRoleColorText').value = document.getElementById('customRoleColor').value;
        document.getElementById('gradientEndColorText').value = document.getElementById('gradientEndColor').value;
        // Initial preview update if custom role is already selected
        if (roleSelect.value === 'custom') {
            updateRolePreview();
        }
    });


    // Form submission handling
    form.addEventListener('submit', function(e) {
        if (currentStep < steps.length - 1) {
            e.preventDefault(); // Prevent submission if not on the last step
            // Optional: move to next step if user clicks submit on non-last step
            // goToStep(currentStep + 1);
        } else {
            // Last step, perform final validation before submitting
            const nicknameInput = form.querySelector('#nickname');
            if (!nicknameInput.value.trim()) {
                alert('Пожалуйста, введите игровой никнейм.');
                e.preventDefault();
                return;
            }
            // Add any other final validation checks here if necessary
        }
    });

    // Initialize UI on load
    calculateStats();
    updateFormUI();
});


// Delete Confirmation Modal
function confirmDelete(playerId, playerName) {
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    document.getElementById('deletePlayerName').textContent = playerName;
    const deleteForm = document.getElementById('deleteForm');
    deleteForm.action = `/admin/delete_player/${playerId}`; // Assuming the route is like this
    modal.show();
}

// Clear Confirmation Modal
document.getElementById('clearConfirmation').addEventListener('input', function() {
    const submitButton = document.getElementById('clearSubmit');
    if (this.value.toUpperCase() === 'ОЧИСТИТЬ') {
        submitButton.disabled = false;
    } else {
        submitButton.disabled = true;
    }
});

// Admin Actions - Category Switching
document.querySelectorAll('.category-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');

        const category = this.dataset.category;
        document.querySelectorAll('.action-category').forEach(cat => cat.classList.remove('active'));
        document.querySelector(`.action-category[data-category="${category}"]`).classList.add('active');
    });
});

// Admin Actions - Confirmations
function confirmClear() {
    const modal = new bootstrap.Modal(document.getElementById('clearModal'));
    modal.show();
}

// Placeholder for any quest system enhancements if needed later
// Example:
// document.addEventListener('DOMContentLoaded', function() {
//     // Quest system initialization or updates
// });

</script>
{% endblock %}